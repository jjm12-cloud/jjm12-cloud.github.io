<!DOCTYPE html>
<html lang="pt">
<head>
  <!-- UTMify UTMs -->
  <script
    src="https://cdn.utmify.com.br/scripts/utms/latest.js"
    data-utmify-prevent-xcod-sck
    data-utmify-prevent-subids
    async defer
  ></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pagamento Seguro</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    :root{ --green:#049D43; --ink:#0f172a; --muted:#6b7280; }
    *{ box-sizing:border-box }
    body{ font-family:Arial,Helvetica,sans-serif; margin:0; color:var(--ink); background:#fff }
    .top-alert{ background:#d32f2f; color:#fff; padding:10px; font-weight:700; text-align:center }
    .wrap{ display:flex; justify-content:center; padding:24px }
    .card{ width:100%; max-width:480px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:22px }
    h2{ margin:0 0 6px }
    .price{ color:#1976d2; font-weight:700; margin-bottom:14px }
    input,button{ width:100%; padding:12px; border:1px solid #cbd5e1; border-radius:8px; font-size:16px; background:#fff }
    input{ margin-top:10px }
    .paylabel{ font-weight:700; margin-top:14px }
    .opts{ display:flex; gap:12px; margin-top:10px }
    .opts img{ width:120px; height:auto; padding:8px; border-radius:10px; background:#fff; cursor:pointer; border:2px solid transparent; transition:border .2s }
    .status{ background:#eaf2ff; color:#1976d2; padding:12px; border-radius:8px; font-weight:700; margin:18px 0 10px; text-align:center }
    .mini{ font-size:12px; color:var(--muted); margin-top:6px }
    #num{ display:none } #hint{ display:none; font-size:12px; color:#666; margin-top:6px }
    .btn{ background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:16px; cursor:pointer }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:1000 }
    .spinner{ width:140px; height:140px; border:10px solid #4ade80; border-top:10px solid transparent; border-radius:50%; animation:spin 1s linear infinite; display:flex; align-items:center; justify-content:center; font:700 32px/1 Arial; color:#fff; position:relative }
    .spinner span{ position:absolute }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="top-alert">‚ö†Ô∏è Esta oferta expira em <span id="timer">05:00</span></div>

  <div class="wrap">
    <div class="card">
      <h2>Taxa do Google</h2>
      <div class="price">197,00 MZN</div>

      <input id="nome" type="text" placeholder="Nome completo" />
      <input id="email" type="email" placeholder="E-mail" />
      <input id="zap" type="tel" placeholder="N√∫mero de WhatsApp" />

      <div class="paylabel">M√©todo de pagamento</div>
      <div class="opts">
        <img id="mpesa-img" src="https://lifeboostsecrets.online/back/images/mpesa.png" alt="M-Pesa" />
        <img id="emola-img" src="https://lifeboostsecrets.online/back/images/emola.png" alt="e-Mola" />
      </div>

      <input id="num" type="tel" inputmode="numeric" maxlength="9" autocomplete="tel" placeholder="EX: 84/85/86/87 xxxxxxx" />
      <div id="hint"></div>
      <div class="mini">O n√∫mero deve ter exatamente 9 d√≠gitos (ex.: 84xxxxxxx).</div>

      <div class="status" id="status">üîí Pagamento seguro</div>
      <button class="btn" id="btn">Finalizar compra 197,00 MZN</button>
    </div>
  </div>

  <div class="overlay" id="overlay"><div class="spinner"><span id="spinNum">45</span></div></div>

  <script>
    /* ===== CONFIG ===== */
    const API_BASE = 'https://api.xerecapay.com';
    const AMOUNT_MZN = 197;
    const REFERENCE_PREFIX = 'TaxaGoogle';
    const AFTER_SUCCESS_URL = 'https://alwayshealthy.live/upsell-1/';

    /* ===== util fbc/fbp e UTM ===== */
    function getCookie(name){ return document.cookie.split('; ').find(v=>v.startsWith(name+'='))?.split('=')[1] || null; }
    const urlp = new URLSearchParams(location.search);
    const fbp = getCookie('_fbp');
    const fbc = getCookie('_fbc') || (urlp.get('fbclid') ? `fb.1.${Date.now()}.${urlp.get('fbclid')}` : null);
    const utm = {
      utm_source:  urlp.get('utm_source')  || null,
      utm_medium:  urlp.get('utm_medium')  || null,
      utm_campaign:urlp.get('utm_campaign')|| null,
      utm_term:    urlp.get('utm_term')    || null,
      utm_content: urlp.get('utm_content') || null,
      fbc, fbp
    };

    /* ===== Timer ===== */
    (function(){
      let t = 5*60, el = document.getElementById('timer');
      setInterval(() => {
        const m = String(Math.floor(t/60)).padStart(2,'0');
        const s = String(t%60).padStart(2,'0');
        el.textContent = `${m}:${s}`;
        if (t>0) t--;
      }, 1000);
    })();

    /* ===== UI ===== */
    let metodo = null;
    const mpesaImg = document.getElementById('mpesa-img');
    const emolaImg = document.getElementById('emola-img');
    const num = document.getElementById('num');
    const hint = document.getElementById('hint');
    const statusBar = document.getElementById('status');

    mpesaImg.onclick = () => selectMetodo('mpesa');
    emolaImg.onclick = () => selectMetodo('emola');

    function selectMetodo(m){
      metodo = m;
      [mpesaImg, emolaImg].forEach(i => { i.style.border = '2px solid transparent'; });
      (m === 'mpesa' ? mpesaImg : emolaImg).style.border = '2px solid #4caf50';
      num.style.display = 'block'; hint.style.display='block';
      if (m === 'mpesa'){ num.placeholder='EX: 84/85 xxxxxxx'; hint.textContent='Para M-Pesa use prefixo 84 ou 85 (9 d√≠gitos).'; }
      if (m === 'emola'){ num.placeholder='EX: 86/87 xxxxxxx'; hint.textContent='Para e-Mola use prefixo 86 ou 87 (9 d√≠gitos).'; }
      num.focus();
    }
    num.addEventListener('input', () => { num.value = num.value.replace(/\D/g,'').slice(0,9); });

    /* ===== Helpers ===== */
    const onlyDigits = s => String(s||'').replace(/\D/g,'');
    function normalizePhone(raw){
      let n = onlyDigits(raw);
      if (n.startsWith('00258')) n = n.slice(5);
      else if (n.startsWith('258')) n = n.slice(3);
      if (n.startsWith('0')) n = n.slice(1);
      return n.slice(0,9);
    }
    function validPrefix(n, m){
      if (n.length !== 9) return false;
      const p = n.slice(0,2);
      if (m === 'mpesa') return (p === '84' || p === '85');
      if (m === 'emola') return (p === '86' || p === '87');
      return false;
    }
    const newReference = () => `${REFERENCE_PREFIX}-${Date.now()}`;
    function showOverlay(){
      const ov = document.getElementById('overlay'); const sp = document.getElementById('spinNum');
      let c = 45; ov.style.display='flex';
      const it = setInterval(()=>{ sp.textContent = c; c--; if(c<0) clearInterval(it); },1000);
      return () => { ov.style.display='none'; clearInterval(it); };
    }

    /* ===== Sa√∫de do backend (opcional) ===== */
    (async () => {
      try{ await axios.get(`${API_BASE}/health`, {timeout: 6000}); }
      catch{ statusBar.textContent = '‚ö†Ô∏è N√£o consegui falar com a API. Tente novamente.'; }
    })();

    /* ===== Fluxo principal ‚Äî usa /api/pagar ===== */
    document.getElementById('btn').onclick = pagar;

    async function pagar(){
      const nome  = document.getElementById('nome').value.trim();
      const email = document.getElementById('email').value.trim();
      const zap   = document.getElementById('zap').value.trim();
      const raw   = num.value.trim();

      if(!nome || !email || !zap){ alert('Preencha nome, e-mail e WhatsApp.'); return; }
      const meth  = metodo; if(!meth){ alert('Selecione M-Pesa ou e-Mola.'); return; }

      const phone = normalizePhone(raw || zap);
      if(!validPrefix(phone, meth)){ alert('N√∫mero inv√°lido: 84/85 (M-Pesa) ou 86/87 (e-Mola), com 9 d√≠gitos.'); return; }

      const stop = showOverlay();
      statusBar.textContent = '‚è≥ Enviando pedido‚Ä¶ Confirme o PIN no celular.';
      const reference = newReference();

      try{
        const body = {
          metodo: meth,
          phone,
          amount: AMOUNT_MZN,
          reference,
          orderId: reference,
          nome: nome,
          email: email,
          utm_source:   utm.utm_source,
          utm_medium:   utm.utm_medium,
          utm_campaign: utm.utm_campaign,
          utm_term:     utm.utm_term,
          utm_content:  utm.utm_content,
          fbc: utm.fbc,
          fbp: utm.fbp
        };

        const { data, status } = await axios.post(`${API_BASE}/api/pagar`, body, {
          headers:{'Content-Type':'application/json'}, timeout: 120000
        });

        if (status!==200 || data?.status!=='ok') throw new Error(data?.message || 'Falha ao processar');

        statusBar.textContent = 'üéâ Pagamento enviado! Redirecionando‚Ä¶';
        setTimeout(()=>{ location.href = AFTER_SUCCESS_URL; }, 800);

      }catch(err){
        const msg = err?.response?.data?.details?.message || err?.response?.data?.message || err?.message || 'Erro';
        alert('Falha ao processar o pagamento:\n' + msg);
        statusBar.textContent = '‚ö†Ô∏è Erro ao enviar o pedido. Tente novamente.';
      }finally{
        stop();
      }
    }
  </script>
</body>
</html>

</body>
</html>

